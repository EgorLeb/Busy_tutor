from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError
import sqlite3
import json
from flask import Flask, make_response, request, Response


def log(mail, password):
    """
    Function for check of user
    :param mail: email
    :param password: password of the email
    :return: dict with info
    """
    owner = checkInOwners(mail, password)
    if len(owner) != 0:
        return {
            "role": "owner",
            "mail": owner[0][0],
            "fullname": owner[0][2],
            "freeSlots": owner[0][3],
            "busySlots": owner[0][4],
            "phone": owner[0][5]
        }
    visitor = checkInVisitors(mail, password)
    if len(visitor) != 0:
        return {
            "role": "visitor",
            "mail": visitor[0][0],
            "fullname": visitor[0][2],
            "ownerMail": visitor[0][3],
            "phone": visitor[0][4]
        }
    return {}


def reg(mail, password, role, fullname, phone):
    """
    check and create the user
    :param mail: email
    :param password: new password
    :param role: owner or visitor
    :param fullname: name of the user
    :param phone: phone number
    :return: code of response
    """
    if role == 'owner' and len(checkInOwnersOnlyMail(mail)) == 0:
        cursor.execute(f"""
                        INSERT INTO owners VALUES ('{mail}', '{password}', '{fullname}', '[]', '[]', '{phone}')
                        """)
        connection.commit()
    elif role == "visitor" and len(checkInVisitorsOnlyMail(mail)) == 0:
        cursor.execute(f"""
                        INSERT INTO visitors VALUES ('{mail}', '{password}', '{fullname}', '-', '{phone}')
                        """)
        connection.commit()
    else:
        return 405
    return 200


def checkInOwners(mail, password):
    """
    Checking of user in the DB (owners) by using email and password
    :param mail: email
    :param password: password
    :return: list with user
    """
    cursor.execute(f"""
            SELECT * FROM owners
            WHERE mail = '{mail}' and password = '{password}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInOwnersOnlyMail(mail):
    """
    Checking of user in the DB (owners) by using email
    :param mail: email
    :return: list with user
    """
    cursor.execute(f"""
            SELECT * FROM owners
            WHERE mail = '{mail}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInVisitors(mail, password):
    """
    Checking of user in the DB (visitors) by using email and password
    :param mail: email
    :param password: password
    :return: list with user
    """
    cursor.execute(f"""
            SELECT * FROM visitors
            WHERE mail = '{mail}' and password = '{password}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInVisitorsOnlyMail(mail):
    """
    Checking of user in the DB (visitors) by using email
    :param mail: email
    :return: list with user
    """
    cursor.execute(f"""
            SELECT * FROM visitors
            WHERE mail = '{mail}'
            """)
    rows = cursor.fetchall()
    return rows


def getTime(mail):
    """
    Getting time by using the email
    :param mail: email
    :return: dict
    """
    cursor.execute(f"""
                SELECT * FROM owners
                WHERE mail = '{mail}'
                """)
    rows = cursor.fetchall()
    if len(rows) == 0:
        return None
    return {
        "freeSlots": rows[0][3],
        "busySlots": rows[0][4]
    }


def setFreeSlots(mail, data):
    """
    Setting free slots in DB for owner
    :param mail: email
    :param data: free slots (string)
    :return: None
    """
    cursor.execute(f"""UPDATE owners SET freeSlots = '{data}' where mail = '{mail}'""")
    connection.commit()


def setBusySlots(mail, data):
    """
    Setting busy slots in DB for owner
    :param mail: email
    :param data: busy slots (string)
    :return: None
    """
    cursor.execute(f"""UPDATE owners SET busySlots = '{data}' where mail = '{mail}'""")
    connection.commit()


def cleaner():
    """
    clean the DB
    :return: None
    """
    cursor.execute("""
                DROP TABLE owners;
                """)
    cursor.execute("""
                DROP TABLE visitors;
                """)
    connection.commit()


def getInfo(mail):
    """
    Get info about owner by mail
    :param mail: email
    :return: dict
    """
    owner = checkInOwnersOnlyMail(mail)
    if len(owner) != 0:
        return {
            "role": "owner",
            "mail": owner[0][0],
            "fullname": owner[0][2],
            "freeSlots": owner[0][3],
            "busySlots": owner[0][4]
        }
    # visitor = checkInVisitorsOnlyMail(mail)
    # if len(visitor) != 0:
    #     return {
    #         "role": "visitor",
    #         "mail": visitor[0][0],
    #         "fullname": visitor[0][2],
    #         "ownerMail": visitor[0][3]
    #     }
    return False


def setOwner(mail, password, ownerMail):
    """
    set owner for visitor
    :param mail: email of the visitor
    :param password: password
    :param ownerMail: mail of owner
    :return: code of response
    """
    f1 = checkInVisitors(mail, password)
    f2 = checkInOwnersOnlyMail(ownerMail)
    if len(f1) != 0 and len(f2) != 0:
        cursor.execute(f"""UPDATE visitors SET ownerMail = '{ownerMail}' where mail = '{mail}' and password = '{password}'""")
        connection.commit()
        return 200
    else:
        return 406


connection = sqlite3.connect('mydatabase.db')
cursor = connection.cursor()

# cleaner()  # ------------очищение базы данных------------

cursor.execute("""
CREATE TABLE IF NOT EXISTS owners (
    mail TEXT,
    password TEXT,
    fullname TEXT,
    freeSlots TEXT,
    busySlots TEXT,
    phone TEXT
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS visitors (
    mail TEXT,
    password TEXT,
    fullname TEXT,
    ownerMail TEXT,
    phone TEXT
)
""")
connection.commit()

def create_event(name="Event", location="Online",
                 description="Description", start="2023-07-23T10:00:00+03:00",
                 end="2023-07-23T13:00:00+03:00", frequency="DAILY", count=1, attendees=None):

    SCOPES = ['https://www.googleapis.com/auth/calendar']
    creds = Credentials.from_authorized_user_file('token.json', SCOPES)
    final_attendees = []
    print(creds)
    # for attendee in attendees:
    #     if attendee != "":
    #         final_attendees.append({'email': f'{attendee}'})
    try:
        service = build("calendar", "v3", credentials=creds)
        event = {
            "summary": name,
            "location": location,
            "description": description,
            "colorId": 10,
            "start": {
                "dateTime": start,
                "timeZone": "Europe/Moscow"
            },
            "end": {
                "dateTime": end,
                "timeZone": "Europe/Moscow"
            },
            "recurrence": [
                f"RRULE:FREQ={frequency};COUNT={count}"
            ]
        }
        event = service.events().insert(calendarId="primary", sendNotifications=True, body=event).execute()
        return {"link": event.get('htmlLink')}
    except HttpError as error:
        return 'An error occurred: %s' % error

# def create_event_old(name="Event", location="Online",
#                  description="Description", start="2023-08-23T10:00:00+03:00",
#                  end="2023-08-23T13:00:00+03:00", frequency="DAILY", count=1, attendees=None):
#     SCOPES = ['https://www.googleapis.com/auth/calendar']
#     creds = Credentials.from_authorized_user_file('token.json', SCOPES)
#     final_attendees = []
#     for attendee in attendees:
#         if attendee != '':
#             final_attendees.append({'email': f'{attendee}'})
#     try:
#         service = build("calendar", "v3", credentials=creds)
#         event = {
#             "summary": name,
#             "location": location,
#             "description": description,
#             "colorId": 10,
#             "start": {
#                 "dateTime": start,
#                 "timeZone": "Europe/Moscow"
#             },
#             "end": {
#                 "dateTime": end,
#                 "timeZone": "Europe/Moscow"
#             },
#             "recurrence": [
#                 f"RRULE:FREQ={frequency};COUNT={count}"
#             ],
#             "attendees": final_attendees
#         }
#         event = service.events().insert(calendarId="primary", sendNotifications=True, body=event).execute()
#         return {"link": event.get('htmlLink')}
#     except HttpError as error:
#         return None


app = Flask(__name__)

cn = 0
app.debug = True


@app.route('/', methods=["POST", "GET", "OPTIONS"])
def index():
    """
    main function of Flask
    :return: dict
    """
    if request.method in ["GET", "OPTIONS"]:
        resp = make_response("Hello, I am Egor. Server do not available for you in this method(", 200)
        resp.headers["Access-Control-Allow-Origin"] = "*"
        resp.headers["Content-Type"] = "application/json; charset=utf-8"
        resp.headers["Access-Control-Allow-Headers"] = "*"
        return resp

    global cn, connection, cursor
    cn += 1

    data_json = request.get_json()  # dict()

    code_response = 200
    res = {}
    if data_json.get("type", "-") == "log" and "mail" in data_json and "password" in data_json:
        res = log(data_json["mail"], data_json["password"])
        if len(res) == 0:
            code_response = 406
    elif data_json.get("type", "-") == "reg" and "mail" in data_json and "password" in data_json \
            and "role" in data_json and "fullname" in data_json and "phone" in data_json:
        code_response = reg(data_json["mail"], data_json["password"], data_json["role"], data_json["fullname"],
                            data_json["phone"])
    elif data_json.get("type", "-") == "getTime" and "ownerMail" in data_json:
        res = getTime(data_json["ownerMail"])
        if res is None:
            res = {}
            code_response = 406
    elif data_json.get("type", "-") == "setTime" and "mail" in data_json \
            and "freeSlots" in data_json and "busySlots" in data_json:
        if len(checkInOwnersOnlyMail(data_json["mail"])) != 0:
            setFreeSlots(data_json["mail"], data_json["freeSlots"])
            setBusySlots(data_json["mail"], data_json["busySlots"])
        else:
            code_response = 406
    elif data_json.get("type", "-") == "createEvent" and "mail" in data_json and "password" in data_json and \
            "secondMail" in data_json and "nameOfEvent" in data_json and "description" in data_json and \
            "start" in data_json and "end" in data_json:
        if len(checkInOwners(data_json["mail"], data_json["password"])) != 0 or \
                len(checkInVisitors(data_json["mail"], data_json["password"])) != 0:
            res = create_event()
            if not res:
                code_response = 404
        else:
            code_response = 406
    elif data_json.get("type", "-") == "getInfo" and "mail" in data_json:
        res = getInfo(data_json["mail"])
        if not res:
            code_response = 406
    elif data_json.get("type", '-') == "setOwner" and "mail" in data_json and "password" in data_json and "ownerMail" in data_json:
        code_response = setOwner(data_json['mail'], data_json["password"], data_json["ownerMail"])
    else:
        code_response = 404
    connection.commit()

    resp = make_response(json.dumps(res), code_response)
    resp.headers["Content-Type"] = "application/json; charset=utf-8"
    resp.headers["Access-Control-Allow-Origin"] = "*"
    resp.headers["Access-Control-Allow-Headers"] = "*"

    return resp
