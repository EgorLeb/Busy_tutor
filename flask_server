from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError
import sqlite3
import json
from flask import Flask, make_response, request, Response


def log(mail, password):
    owner = checkInOwners(mail, password)
    if len(owner) != 0:
        return {
            "role": "owner",
            "mail": owner[0][0],
            "fullname": owner[0][2],
            "freeSlots": owner[0][3],
            "busySlots": owner[0][4],
            "phone": owner[0][5]
        }
    visitor = checkInVisitors(mail, password)
    if len(visitor) != 0:
        return {
            "role": "visitor",
            "mail": visitor[0][0],
            "fullname": visitor[0][2],
            "ownerMail": visitor[0][3],
            "phone": visitor[0][4]
        }
    return {}


def reg(mail, password, role, fullname, phone, ownerMail=''):
    if role == 'owner' and len(checkInOwnersOnlyMail(mail)) == 0:
        cursor.execute(f"""
                        INSERT INTO owners VALUES ('{mail}', '{password}', '{fullname}', '[]', '[]', '{phone}')
                        """)
        connection.commit()
    elif role == "visitor" and len(checkInVisitorsOnlyMail(mail)) == 0:
        cursor.execute(f"""
                        INSERT INTO visitors VALUES ('{mail}', '{password}', '{fullname}', '{ownerMail}', '{phone}')
                        """)
        connection.commit()
    else:
        return 405
    return 200


def checkInOwners(mail, password):
    cursor.execute(f"""
            SELECT * FROM owners
            WHERE mail = '{mail}' and password = '{password}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInOwnersOnlyMail(mail):
    cursor.execute(f"""
            SELECT * FROM owners
            WHERE mail = '{mail}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInVisitors(mail, password):
    cursor.execute(f"""
            SELECT * FROM visitors
            WHERE mail = '{mail}' and password = '{password}'
            """)
    rows = cursor.fetchall()
    return rows


def checkInVisitorsOnlyMail(mail):
    cursor.execute(f"""
            SELECT * FROM visitors
            WHERE mail = '{mail}'
            """)
    rows = cursor.fetchall()
    return rows


def getTime(mail):
    cursor.execute(f"""
                SELECT * FROM owners
                WHERE mail = '{mail}'
                """)
    rows = cursor.fetchall()
    if len(rows) == 0:
        return None
    return {
        "freeSlots": rows[0][3],
        "busySlots": rows[0][4]
    }


def setFreeSlots(mail, password, data):
    cursor.execute(f"""UPDATE owners SET freeSlots = '{data}' where mail = '{mail}' and password = '{password}'""")
    connection.commit()


def setBusySlots(mail, password, data):
    cursor.execute(f"""UPDATE owners SET busySlots = '{data}' where mail = '{mail}' and password = '{password}'""")
    connection.commit()


def cleaner():
    cursor.execute("""
                DROP TABLE owners;
                """)
    cursor.execute("""
                DROP TABLE visitors;
                """)
    connection.commit()


def getInfo(mail):
    owner = checkInOwnersOnlyMail(mail)
    if len(owner) != 0:
        return {
            "role": "owner",
            "mail": owner[0][0],
            "fullname": owner[0][2],
            "freeSlots": owner[0][3],
            "busySlots": owner[0][4]
        }
    visitor = checkInVisitorsOnlyMail(mail)
    if len(visitor) != 0:
        return {
            "role": "visitor",
            "mail": visitor[0][0],
            "fullname": visitor[0][2],
            "ownerMail": visitor[0][3]
        }
    return None


connection = sqlite3.connect('mydatabase.db')
cursor = connection.cursor()

# cleaner()  # ------------очищение базы данных------------

cursor.execute("""
CREATE TABLE IF NOT EXISTS owners (
    mail TEXT,
    password TEXT,
    fullname TEXT,
    freeSlots TEXT,
    busySlots TEXT,
    phone TEXT
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS visitors (
mail TEXT,
    password TEXT,
    fullname TEXT,
    ownerMail TEXT,
    phone TEXT
)
""")
connection.commit()

def create_event(name="Event", location="Online",
                 description="Description", start="2023-06-23T10:00:00+03:00",
                 end="2023-06-23T13:00:00+03:00", frequency="DAILY", count=1, attendees=None):
    SCOPES = ['https://www.googleapis.com/auth/calendar']
    creds = Credentials.from_authorized_user_file('token.json', SCOPES)
    final_attendees = []
    for attendee in attendees:
        final_attendees.append({'email': f'{attendee}'})
    try:
        service = build("calendar", "v3", credentials=creds)
        event = {
            "summary": name,
            "location": location,
            "description": description,
            "colorId": 10,
            "start": {
                "dateTime": start,
                "timeZone": "Europe/Moscow"
            },
            "end": {
                "dateTime": end,
                "timeZone": "Europe/Moscow"
            },
            "recurrence": [
                f"RRULE:FREQ={frequency};COUNT={count}"
            ],
            "attendees": final_attendees
        }
        event = service.events().insert(calendarId="primary", sendNotifications=True, body=event).execute()
        return {"link": event.get('htmlLink')}
    except HttpError as error:
        return None


app = Flask(name)

cn = 0
app.debug = True


@app.route('/', methods=["POST", "GET", "OPTIONS"])

def index():
    if request.method in ["GET", "OPTIONS"]:
        resp = make_response("Hello, I am Egor. Server do not available for you in this method(", 200)
        resp.headers["Access-Control-Allow-Origin"] = "*"
        resp.headers["Content-Type"] = "application/json; charset=utf-8"
        resp.headers["Access-Control-Allow-Headers"] = "*"
        return resp
    
    
    global cn, connection, cursor
    cn += 1

    data_json = request.get_json()  # dict()
         code_response = 200
    res = {}
    if data_json.get("type", "-") == "log" and "mail" in data_json and "password" in data_json:
        res = log(data_json["mail"], data_json["password"])
        if len(res) == 0:
            code_response = 406
    elif data_json.get("type", "-") == "reg" and "mail" in data_json and "password" in data_json \
            and "role" in data_json and "fullname" in data_json and "phone" in data_json:
        code_response = reg(data_json["mail"], data_json["password"], data_json["role"], data_json["fullname"],
                            data_json["phone"], data_json.get("ownerMail", ""))
    elif data_json.get("type", "-") == "getTime" and "mail" in data_json:
        res = getTime(data_json["mail"])
        if res is None:
            res = {}
            code_response = 406
    elif data_json.get("type", "-") == "setTime" and "mail" in data_json and "password" in data_json \
            and "freeSlots" in data_json and "busySlots" in data_json:
        if len(checkInOwners(data_json["mail"], data_json["password"])) != 0:
            setFreeSlots(data_json["mail"], data_json["password"], data_json["freeSlots"])
            setBusySlots(data_json["mail"], data_json["password"], data_json["busySlots"])
        else:
            code_response = 406
    elif data_json.get("type", "-") == "createEvent" and "mail" in data_json and "password" in data_json and\
            "secondMail" in data_json and "nameOfEvent" in data_json and "description" in data_json and\
            "start" in data_json and "end" in data_json:
        if len(checkInOwners(data_json["mail"], data_json["password"])) != 0 or \
                len(checkInVisitors(data_json["mail"], data_json["password"])) != 0:
            res = create_event(name=data_json["nameOfEvent"], description=data_json["description"],
                               start=data_json["start"], end=data_json["end"],
                               attendees=([data_json["mail"], data_json["secondMail"]]) if len(data_json["secondMail"]) != 0 else [data_json["mail"]])
            if len(res) == 0:
                code_response = 404
        else:
            code_response = 406
    else:
        code_response = 404
    connection.commit()

    resp = make_response(json.dumps(res), code_response)
    resp.headers["Content-Type"] = "application/json; charset=utf-8"
    resp.headers["Access-Control-Allow-Origin"] = "*"
    resp.headers["Access-Control-Allow-Headers"] = "*"

    return resp


# @app.route('/', methods=["GET", "OPTIONS"])
# def index_GET():
#     resp = make_response("Hello, I am Egor. Server do not available for you in this method(", 200)
#     resp.headers["Access-Control-Allow-Origin"] = "*"
#     resp.headers["Content-Type"] = "application/json; charset=utf-8"
#     resp.headers["Access-Control-Allow-Headers"] = "*"
#     return resp
